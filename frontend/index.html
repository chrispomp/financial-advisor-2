<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citi AI Wealth Advisor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary-blue: #003B70; --primary-red: #D9261C; --neutral-bg: #FFFFFF; --neutral-light-gray: #F0F2F5; --status-green: #28a745; --font-family: 'Helvetica Neue', Arial, sans-serif; }
        body { background-color: var(--neutral-light-gray); font-family: var(--font-family); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .mobile-container { width: 100%; max-width: 400px; height: 85vh; max-height: 750px; background-color: var(--neutral-bg); border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); overflow: hidden; display: flex; flex-direction: column; }
        header { padding: 15px 20px; background-color: var(--primary-blue); text-align: center; flex-shrink: 0; }
        header img { height: 30px; }
        main { flex-grow: 1; position: relative; background-color: #000; display: flex; flex-direction: column; justify-content: space-between; }
        .agent-view { position: relative; width: 100%; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .agent-placeholder { text-align: center; color: #ccc; }
        .agent-placeholder i { font-size: 80px; margin-bottom: 20px; }
        .agent-placeholder.active i { color: var(--primary-blue); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        #agent-transcript { position: absolute; bottom: 20px; left: 20px; right: 20px; background: rgba(0, 0, 0, 0.5); color: white; padding: 15px; border-radius: 10px; text-align: center; font-size: 1.1em; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .status-overlay { position: absolute; top: 10px; left: 10px; background-color: rgba(0, 0, 0, 0.5); color: white; padding: 5px 10px; border-radius: 15px; font-size: 14px; display: flex; align-items: center; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: var(--primary-red); margin-right: 8px; }
        .status-dot.connected { background-color: var(--status-green); }
        .controls { padding: 20px; background-color: #000; display: flex; justify-content: center; gap: 20px; flex-shrink: 0; }
        .control-button { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; color: white; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s; }
        #startStopBtn { background-color: var(--primary-blue); }
        #startStopBtn.active { background-color: var(--primary-red); }
        #muteBtn { background-color: rgba(255, 255, 255, 0.3); }
        #muteBtn:disabled { background-color: rgba(255, 255, 255, 0.1); cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="mobile-container">
        <header><img src="https://upload.wikimedia.org/wikipedia/commons/1/1b/Citi.svg" alt="Citi Logo"></header>
        <main>
            <div class="agent-view">
                <video id="localVideo" autoplay muted playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
                <div class="agent-placeholder" id="agent-placeholder" style="position: absolute; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px;">
                    <i class="fa-solid fa-brain"></i>
                    <p>Session not started</p>
                </div>
                <div id="agent-transcript"><p>...</p></div>
                <div class="status-overlay">
                    <div id="status-dot" class="status-dot"></div><span id="status-text">Disconnected</span>
                </div>
            </div>
            <div class="controls">
                <button id="muteBtn" class="control-button" disabled aria-label="Mute microphone"><i class="fa-solid fa-microphone"></i></button>
                <button id="startStopBtn" class="control-button" aria-label="Start call"><i class="fa-solid fa-phone"></i></button>
            </div>
        </main>
    </div>

    <script>
        const ui = {
            startStopBtn: document.getElementById('startStopBtn'),
            muteBtn: document.getElementById('muteBtn'),
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot'),
            placeholder: document.getElementById('agent-placeholder'),
            transcript: document.getElementById('agent-transcript'),
        };

        const initialState = {
            isConversationActive: false,
            isMuted: false,
            localStream: null,
            socket: null,
            audioContext: null,
            audioProcessor: null,
            audioPlayer: null,
            transcriptText: '',
            videoStreamInterval: null,
        };

        let state = { ...initialState };

        const serverUrl = 'http://localhost:8000';

        ui.startStopBtn.addEventListener('click', () => state.isConversationActive ? endConversation() : startConversation());
        ui.muteBtn.addEventListener('click', toggleMute);

        // --- Core Conversation Logic ---

        async function startConversation() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: { sampleRate: 16000, channelCount: 1 }
                });
                
                state.localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                ui.placeholder.style.display = 'none'; // Hide placeholder

                await connectToAgent(stream);

                state.isConversationActive = true;
                ui.startStopBtn.classList.add('active');
                ui.startStopBtn.querySelector('i').className = 'fa-solid fa-phone-slash';
                ui.startStopBtn.ariaLabel = 'End call';
                ui.muteBtn.disabled = false;
                ui.placeholder.querySelector('p').textContent = 'Listening...';
            } catch (error) {
                console.error("❌ Failed to start conversation:", error);
                alert("Could not start. Check console for errors.");
                endConversation();
            }
        }

        function endConversation() {
            if (state.videoStreamInterval) {
                clearInterval(state.videoStreamInterval);
            }
            state.localStream?.getTracks().forEach(track => track.stop());
            state.socket?.close();
            state.audioContext?.close();

            document.getElementById('localVideo').srcObject = null;
            ui.placeholder.style.display = 'flex';
            ui.placeholder.querySelector('p').textContent = 'Session ended';
            ui.statusText.textContent = 'Disconnected';
            ui.statusDot.classList.remove('connected');
            ui.transcript.innerHTML = '<p>...</p>';

            // Reset state object
            state = { ...initialState };

            ui.startStopBtn.classList.remove('active');
            ui.startStopBtn.querySelector('i').className = 'fa-solid fa-phone';
            ui.startStopBtn.ariaLabel = 'Start call';
            ui.muteBtn.disabled = true;
            ui.muteBtn.querySelector('i').className = 'fa-solid fa-microphone';
        }

        // --- Network and Media Setup ---

        function connectToAgent(stream) {
            return new Promise(async (resolve, reject) => {
                const wsUrl = serverUrl.replace('http', 'ws');
                // The ADK server expects user and session IDs for authorization.
                const userId = `user_${Date.now()}`;
                const sessionId = `session_${Date.now()}`;
                const connectUrl = `${wsUrl}/run_live?user_id=${userId}&session_id=${sessionId}`;

                console.log(`Connecting to: ${connectUrl}`);
                state.socket = new WebSocket(connectUrl);
                state.socket.binaryType = "arraybuffer";

                state.socket.onopen = async () => {
                    console.log("✅ WebSocket connected. Initializing audio processor.");
                    ui.statusText.textContent = 'Connected';
                    ui.statusDot.classList.add('connected');
                    try {
                        await setupAudio(stream);
                        resolve();
                    } catch (e) { reject(e); }
                };

                state.socket.onmessage = handleAgentMessage;
                state.socket.onerror = (err) => { console.error("❌ WebSocket Error:", err); reject(err); };
                state.socket.onclose = () => { console.log("🔌 WebSocket closed."); if(state.isConversationActive) endConversation(); };
            });
        }

        async function setupAudio(stream) {
            // The API output is 24kHz, so we should set our context to that for proper playback.
            state.audioContext = new AudioContext({ sampleRate: 24000 });

            // Setup audio recorder (sends 16kHz audio from microphone)
            const source = state.audioContext.createMediaStreamSource(stream);
            const recorderWorklet = new AudioWorkletNode(state.audioContext, 'audio-processor');
            source.connect(recorderWorklet);
            recorderWorklet.port.onmessage = event => {
                // event.data is a Uint8Array of PCM data
                sendPacket('audio/pcm;rate=16000', event.data.buffer);
            };
            // We need to load the module for the recorder before we can create the node
            await state.audioContext.audioWorklet.addModule('audio-processor.js');


            // Setup audio player (receives 24kHz audio from agent)
            await state.audioContext.audioWorklet.addModule('audio-player.js');
            state.audioPlayer = new AudioWorkletNode(state.audioContext, 'audio-player-processor');
            state.audioPlayer.connect(state.audioContext.destination);

            // Start streaming video frames
            startVideoStream();
        }

        // --- Data Streaming Logic ---

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function sendPacket(mimeType, data) {
            const base64Data = arrayBufferToBase64(data);
            const packet = {
                content: {
                    parts: [{ inline_data: { mime_type: mimeType, data: base64Data } }]
                }
            };
            if (state.socket && state.socket.readyState === WebSocket.OPEN) {
                state.socket.send(JSON.stringify(packet));
            }
        }

        function startVideoStream() {
            const videoElement = document.getElementById('localVideo');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const frameRate = 5; // 5 frames per second

            state.videoStreamInterval = setInterval(() => {
                if (videoElement.readyState >= 2) { // HAVE_CURRENT_DATA
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(blob => {
                        blob.arrayBuffer().then(buffer => {
                            sendPacket('image/jpeg', buffer);
                        });
                    }, 'image/jpeg', 0.7);
                }
            }, 1000 / frameRate);
        }

        // --- Agent Message Handling ---

        function handleAgentMessage(event) {
            if (event.data instanceof ArrayBuffer) {
                // This is an audio chunk, send it to the player
                state.audioPlayer.port.postMessage({ pcmData: new Int16Array(event.data) });
                return;
            }
            
            // This is a JSON message
            const message = JSON.parse(event.data);
            console.log("Agent Message:", message);

            // Handle transcription updates
            if (message.server_content && message.server_content.output_transcription) {
                const newText = message.server_content.output_transcription.text;
                if (newText) {
                    state.transcriptText = newText;
                    ui.transcript.innerHTML = `<p>${state.transcriptText}</p>`;
                }
            }

            // When the model turn is complete, clear the transcript for the next turn
            if (message.server_content && message.server_content.turn_complete) {
                state.transcriptText = '';
            }
        }
        
        // --- Utility Functions ---

        function toggleMute() {
            if (!state.localStream) return;
            state.isMuted = !state.isMuted;
            state.localStream.getAudioTracks()[0].enabled = !state.isMuted;
            ui.muteBtn.querySelector('i').className = state.isMuted ? 'fa-solid fa-microphone-slash' : 'fa-solid fa-microphone';
        }
    </script>
</body>
</html>